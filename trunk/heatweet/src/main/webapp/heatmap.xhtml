<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core">
<h:head>
	<script type="text/javascript"
		src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script
		src="http://ajax.googleapis.com/ajax/libs/dojo/1.6.0/dojo/dojo.xd.js"></script>
	<h:outputScript library="js" name="heatmap.js" />
	<h:outputScript library="js" name="heatmap-gmaps.js" />

	<script type="text/javascript">
		var map;
		var G = google.maps;
		var geocoder;
		var ret;
		var max = 0;
		
		dojo.ready(initialize);
		function initialize() {
			geocoder = new google.maps.Geocoder();
			var latlng = new google.maps.LatLng(-22.54, -43.13);
			var myOptions = {
				zoom : 5,
				center : latlng,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(dojo.byId("map_canvas"), myOptions);

		}
		function code(address, heatmap, count) {			
			ret = geocoder.geocode({
				'address' : address
			}, function(results, status) {				
				if (status == google.maps.GeocoderStatus.OK) {
					var latlng = results[0].geometry.location;
					var lat = latlng.toString().split(',')[0];
					lat = lat.substr(1);
					var lng = latlng.toString().split(',')[1];
					lng = lng.substr(1, lng.length - 2);
					heatmap.addDataPoint(lat, lng, count);
					
					
				} else {
					alert("Geocode was not successful for the following reason: "
							+ status);
				}						
			});						

		}
		function codeAddress() {
			var address = dojo.byId("local").value;
			geocoder
					.geocode(
							{
								'address' : address
							},
							function(results, status) {
								if (status == google.maps.GeocoderStatus.OK) {
									var latlng = results[0].geometry.location;
									var lat = latlng.toString().split(',')[0];
									lat = lat.substr(1);
									var lng = latlng.toString().split(',')[1];
									lng = lng.substr(1, lng.length - 2);

									var myOptions = {
										zoom : 6,
										center : results[0].geometry.location,
										mapTypeId : google.maps.MapTypeId.ROADMAP
									};
									map = new google.maps.Map(dojo
											.byId("map_canvas"), myOptions);
									var marker = new google.maps.Marker({
										map : map,
										position : results[0].geometry.location

									});

								} else {
									alert("Geocode was not successful for the following reason: "
											+ status);
								}
							});
		}
		var data;
		function addPoints() {
			var url = "/heatweet/fusion/selectByLocationByDate?table=2228251";
			//var url = "/heatweet/fusion/selectByLocation?table=2228856";
			var url2= "/heatweet/fusion/selectDates?table=2228251";
			var heatmap = new HeatmapOverlay(map, {
				"radius" : 15,
				"visible" : true,
				"opacity" : 60
			});
			var dados;
			dojo.xhrGet({
				url : url2,
				load : function(response) {
					datas = response.split(";");					
					dojo.forEach(datas, function(item, index) {
						
						if (index != 0) {
							dojo.xhrGet({ 								
								url : url+"&amp;date="+encodeURIComponent(item.split(",")[0]),
								load : function(response) {
									dados = response.split(";");
									dojo.forEach(dados, function(item, index) {
										if (index != 0) {
											local = item.split(",")[0].toString().replace("\"",
											"").replace(",", " ");
												count = item.split(",")[1];
												if(count > max) {
													max = count;
												}
												heatmap.addDataPoint(local.split(" ")[0], local.split(" ")[1], count);
										}
									});
								}
							});
							
							/*dojo.xhrGet({
								url : url2+local,
								load : function(response) {
									if(response != "")
									var lat = response.toString().split(";")[0];
									var lng = response.toString().split(";")[1];
									heatmap.addDataPoint(lat, lng, count);
								}
							});*/
							//code(local,heatmap,count);
							
						}						
					});

				}
			});

		}

		/* var myJsonText = '{ "points" : [ { "total" :"3","lat" :"0.0","lng" :"0.0"},';
		myJsonText += '{ "total" :"960","lat" :"-22.787371","lng" :"-43.313"},';
		myJsonText += '{ "total" :"600","lat" :"-22.06716","lng" :"-42.921206"},';
		myJsonText += '{ "total" :"350","lat" :"-22.88077","lng" :"-43.103889"},';
		myJsonText += '{ "total" :"50","lat" :"-22.796749","lng" :"-43.039181"},';
		myJsonText += '{ "total" :"300","lat" :"34.994515","lng" :"-76.761809"},';
		myJsonText += '{ "total" :"1","lat" :"-27.60647","lng" :"-54.280001"},';
		myJsonText += '{ "total" :"550","lat" :"39.464298","lng" :"-9.19603"},';
		myJsonText += '{ "total" :"803","lat" :"-22.97673","lng" :"-43.19508"}';
		myJsonText += ']}';*/
	</script>
	<title>HeaTweet</title>
</h:head>
<h:body>
	<h:form id="frm" prependId="false">
		<div>
			<h:outputText value="Busca" />
			<h:inputText required="true" id="search" />
			<h:outputText value="Raio" />
			<h:inputText required="true" id="raio" />
			<h:outputText value="Local" />
			<h:inputText required="true" id="local" />
			<input type="button" value="procurar" onclick="addPoints()" />

		</div>
		<div id="map_canvas" style="width: 100%; height: 600px;"></div>

	</h:form>
</h:body>
</html>
